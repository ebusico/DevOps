# DevOps-O6
## Project breakdown
### ~/ansible - Main file directory:

> **ansible.cfg**: Configuration file for Ansible. When a playbook is executed, Ansible will first search for an ansible.cfg file in the same directory as the playbook, before then looking in the Ansible install location (/etc/ansible) and user home directory. By placing a version of the file here it allows the default configuration options of Ansible to be overwritten for this playbook. This is used to set the Ansible inventory location to be the 'hosts' file which is found in this directory. For more information on Ansible configuration options, refer to the [documentation](https://docs.ansible.com/ansible/latest/reference_appendices/config.html#ansible-configuration-settings).

> **hosts**: Ansible inventory file. This file contains the ip addresses for all the target servers which may be required for this project. These hosts can be sorted by groups using either yaml or ini formatting as described [here](https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html). This is an example of a 'static inventory' as all of the hosts are pre-defined prior to runtime. For information on 'dynamic inventory' usage, including an example with EC2 instances on AWS here is [another reference](https://docs.ansible.com/ansible/latest/user_guide/intro_dynamic_inventory.html).

> **main.yml**: The main playbook file for this project. When executed, this playbook will attempt to run on the 'AppServers' host group as defined in the provided inventory file (\~/ansible/hosts). The 'become', and 'become_method' arguments are used to specify that the playbook should be executed as the root user. This is done as a majority of the tasks performed in this project require root access to be completed successfully. The playbook is split into three sections: 'pre_tasks', 'roles', and 'post_tasks'. The 'pre-tasks', which are defined in the setup.yml file, are executed first. These tasks are performed to ensure that the host enviroment is properly configured prior to main runtime. During this step a variables file (\~/ansible/vars/main.yml) is also attached to the process to import the project-wide variables required for this playbook. The 'roles' section, which is processed next, consists of 3 task-sets named: mongodb, react, and nodeExpress. These task-sets make up the bulk of the playbook. Here each 'role' corrosponds to the set of tasks required to install the associated application component by that name. By default, Ansible will search for details about these roles in a directory named 'roles'. For example, details about the 'react' role should be located in the 'roles/react' directory relative to the playbook. Ansible will execute these roles in the order in which they are supplied (top to bottom), unless otherwise declared. More information about the function of roles can be found in the [Ansible documentation](https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html). 
The 'post_tasks' are completed at the end of the playbook, and currently consist only of a simple 1-line shell command. This acts as a way to confirm that the playbook has reached its' endstate.


> **setup.yml**: Task file. This file outlines all of the tasks to be completed during the 'pre_tasks' phase. The first two tasks utilise the Ansible ['apt'](https://docs.ansible.com/ansible/latest/modules/apt_module.html) module to update and upgrade all of the packages on the target machine to their latest versions. The next task uses a list variable named 'packages' to ensure that all of the initial dependecies required for this playbook are installed. This variable is defined in the vars/main.yml file. More information on the usage of variables with Ansible can be found [here](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html). Using the ['file'](https://docs.ansible.com/ansible/latest/modules/file_module.html) module, Ansible then checks to see if the target machine has an existing version of the react, and node-express application files, and deletes them if they are present. Finally, [the systemd](https://docs.ansible.com/ansible/latest/modules/systemd_module.html) daemon is reloaded to ensure the system state is up-to-date. 

<br/> 

### ~/ansible/vars - System-wide variable directory:

> **main.yml**: Variable file. Any system-wide Ansible variables are defined here. As of now, this includes only the external ip address of the target machine, and a list of the packages which are required for the playbook to run. These are included ([see difference between include and import](https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_includes.html)) during the pre-task phase and, as such can only be called in the playbook from that point [onwards](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html). This file is used to define variables which are used across multiple roles. Role specific variables can be found in the vars/main.yml files found in the role directories.

<br/> 

### ~/ansible/files - Main file directory:

> **nginx.conf** : Configuration file for the nginx package. In this project nginx is used to serve a react application onto the target machine. This file is pre-configured to tell nginx where to find the react files to be served, and what port they will be served onto. By replacing the default configuration file (/etc/nginx/nginx.conf) with this file the correct settings can be quickly deployed to any new host for an easy installation of the react app.
 
> **nodeExpressApp.service** : Service file. This file contains the details required to create a systemd service which will deploy the node-express application component onto a target machine. By copying the file into the machine's system directory (/lib/systemd/system/) the service can be quickly deployed for use. This allows the node-express server to be run as a background process on the host machine. In this file the desired user, working directory of the app, and file to be executed are not pre-chosen. This is instead done during runtime to allow for these values to be dynamic, depending on which installation directory is chosen, and which user is required.

> **bursaryproject/** : This directory contains the application files as found from the project [repository](https://github.com/ebusico/bursaryproject/tree/aws/bursary-app-v1). The files are included as static assets rather than being dynamically updated to emulate the DevOps pipline which has been decided for this project. In this pipeline the files are pulled from the repository, tested, and then deployed only if the tests do not fail. This means that it is not neccecary to pull files during this step, as the files will already be present from prior stages. For further information on the application itself, please refer to the readme file found in the project repository. If the directory structure of this repository has changed, this playbook may no longer work. To rectify this issue, update the src path in the react/vars/main.yml and nodeExpress/vars/main.yml variable files.

<br/> 

### ~/ansible/roles - Ansible role directory:
Each role consists of two components. A tasks/main.yml task file and a vars/main.yml variable file. By using this convention Ansible is able to automatically associate each variable file with the corrosponding task file for every role. This removes the need to ['include' or 'import'](https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_includes.html) the variable files when executing the task-set associated with each role. Further information on Ansible role convention can be found in the [documentation](https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html).

> **mongodb/** : This task-set is based upon the mongoDB installation documentation found [here](https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/#overview). The first step is to use pip to install the pymongo python dependency. Import public GPG key for MongoDB, and create source list file. Install mongoDB package and start as service. Make sure service is running, create MongoDB admin user and then use to construct 'trainees' database.

> **react/** : Ensure all required packages are installed. Send react application files to target host. Edit .env file with correct external ip address. Change access permisions on files to allow for user access. Install nodejs dependencies, and build static react app to be served. Start nginx service and overwrite config file with pre-configured settings. Reload nginx.

> **nodeExpress/** : Ensure all required packages are installed. Send node-express files to host server. Edit .env files with react and mongodb ip. Correct permissions on files to allow for user access. Install nodejs dependencies. Copy service file to host machine. Configure service file and start node-express service.
